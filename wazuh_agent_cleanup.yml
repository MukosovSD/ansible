---
- name: Полная чистка Wazuh Agent (строго по следам установки)
  hosts: all
  become: true

  tasks:
    - name: Покажи инфу про ОС
      ansible.builtin.debug:
        msg: "OS: {{ ansible_facts['os_family'] }} | {{ ansible_facts['distribution'] }}"

    - name: Остановить wazuh-agent
      ansible.builtin.systemd:
        name: wazuh-agent
        state: stopped
      ignore_errors: true

    - name: Удалить wazuh-agent .deb
      ansible.builtin.file:
        path: /tmp/wazuh-agent.deb
        state: absent
      when: ansible_facts['os_family'] == 'Debian'

    - name: Удалить wazuh-agent .rpm
      ansible.builtin.file:
        path: /tmp/wazuh-agent.rpm
        state: absent
      when: ansible_facts['os_family'] in ['RedHat', 'RedOS', 'RED', 'Linux']

    - name: Удалить пакет wazuh-agent (Debian/Ubuntu)
      ansible.builtin.apt:
        name: wazuh-agent
        state: absent
        purge: true
        force: true
      when: ansible_facts['os_family'] == 'Debian'
      ignore_errors: true

    - name: Удалить пакет wazuh-agent (RedHat/RedOS)
      ansible.builtin.yum:
        name: wazuh-agent
        state: absent
      when: ansible_facts['os_family'] in ['RedHat', 'RedOS', 'RED', 'Linux']
      ignore_errors: true

    - name: Удалить /var/ossec (каталог агента)
      ansible.builtin.file:
        path: /var/ossec
        state: absent

    - name: Удалить /etc/init.d/wazuh-agent (если есть)
      ansible.builtin.file:
        path: /etc/init.d/wazuh-agent
        state: absent

    - name: Удалить systemd unit wazuh-agent (если есть)
      ansible.builtin.file:
        path: /usr/lib/systemd/system/wazuh-agent.service
        state: absent

    - name: Перезагрузить systemd (daemon-reload)
      ansible.builtin.command: systemctl daemon-reload

    - name: Убедиться, что агента больше нет
      ansible.builtin.command: systemctl status wazuh-agent
      ignore_errors: true
